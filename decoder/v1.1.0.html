<!DOCTYPE html>
<script src="https://unpkg.com/crypto-js/crypto-js.js"></script>
<style>label,input:not([type="number"]),textarea{display:block;width:100%}</style>
<h1>SaveSystem Decoder 1.1.0</h1>
<label>
  saveData
  <input type="text" id="saveData" autocomplete="off" />
</label>
<label>
  secret token
  <input type="password" id="secretToken" name="secret_token" autocomplete="off" />
</label>
<label>
  RC4-drop bytes
  <input type="number" id="drop" value="768" />
  (set 0; same as <a href="v1.0.0.html">v1.0.0</a>)
</label>
<label>
  player.displayName
  <small>※VRChatが名前文字列の無害化をするので、VRChatホームページのプロフィールから名前をコピペ推奨</small>
  <input type="text" id="playerName" name="player_display_name" autocomplete="off" />
</label>
<label>
  serialized
  <textarea rows="20" id="serialized" readonly></textarea>
</label>
<script>
const { RC4Drop, SHA256 } = CryptoJS
const { Utf8 } = CryptoJS.enc
const error = message => {
  if (message) console.error(message)
  serialized.value = message
}
const decrypt = () => {
  const hash = saveData.value.substring(0, 64)
  const encrypted = saveData.value.substring(64)
  const password = playerName.value
    ? `${secretToken.value}|${playerName.value}`
    : secretToken.value
  if (!hash || !encrypted || !password) return error("")
  try {
    const decrypted = RC4Drop.decrypt(encrypted, Utf8.parse(password), { drop: Number(drop.value) / 4 }).toString(Utf8)
    if (SHA256(decrypted).toString() !== hash) return error("hash check failed")
    serialized.value = JSON.stringify(JSON.parse(decrypted), undefined, 2)
  } catch (e) {
    console.error(e)
    return error("failed to decrypt")
  }
}
[saveData, secretToken, playerName, drop].forEach(input => input.addEventListener('change', decrypt, false))
</script>
